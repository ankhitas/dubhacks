<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Upload</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>

    <div class="container d-flex justify-content-center align-items-start mt-5">
        <div class="box-container">
            <div class="upload-container" id="uploadContainer">
                <h2>Upload an Image for Prediction</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label class="custom-file-upload">
                            <input type="file" class="file-input" id="fileInput" name="file" required>
                            Choose File
                        </label>
                    </div>
                    <div class="image-preview-container">
                        <img id="imagePreview" src="" alt="Image Preview" style="display: none;">
                    </div>
                    <button type="submit" class="btn light-green-btn btn-block">Submit</button>
                </form>
                <div class="result" id="result"></div>
            </div>
            <div class="prediction-container" id="predictionContainer" style="display: none;">
                <h2>Prediction</h2>
                <div class="result" id="resultDisplay"></div>
            </div>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function() {
        $('#fileInput').on('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview').attr('src', e.target.result).show();
                }
                reader.readAsDataURL(file);
            }
        });

        $('#uploadForm').on('submit', function(event) {
            event.preventDefault();
            let formData = new FormData(this);

            $.ajax({
                type: 'POST',
                url: '/predict',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    // Check if prediction data exists
                    if (response.prediction) {
                        let resultHTML = '<ul>';
                        response.prediction.forEach(item => {
                            resultHTML += <li><strong>${item.name}</strong>: ${item.calories}, Serving Size: ${item.serving_size}, Total Fat: ${item.fat_total}, Saturated Fat: ${item.fat_saturated}, Protein: ${item.protein}, Sodium: ${item.sodium}, Potassium: ${item.potassium}, Cholesterol: ${item.cholesterol}, Carbohydrates: ${item.carbohydrates}, Fiber: ${item.fiber}, Sugar: ${item.sugar}</li>;
                        });
                        resultHTML += '</ul>';
                        $('#resultDisplay').html(resultHTML);  // Display the formatted result
                    } else if (response.error) {
                        $('#resultDisplay').text('Error: ' + response.error);
                    }
                    
                    // Display predicted indices if they exist
                    if (response.predicted_indices) {
                        $('#resultDisplay').append('<h4>Predicted Indices:</h4><ul id="predictedIndices"></ul>');
                        response.predicted_indices.forEach(index => {
                            $('#predictedIndices').append(<li>${index}</li>);
                        });
                    }
                    
                    $('#uploadContainer').addClass('slide-out');  // Add class to slide out
                    $('#predictionContainer').fadeIn(500); // Show the prediction box
                },
                error: function() {
                    $('#resultDisplay').text('An error occurred while processing the image.');
                }
            });
        });
    });
</script>

</body>
</html>